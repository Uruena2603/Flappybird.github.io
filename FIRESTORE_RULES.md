# üî• Reglas de Firestore -    // üèÜ LEADERBOARD GLOBAL: Un registro √∫nico por usuario
    match /leaderboard_scores/{scoreId} {
      // LECTURA P√öBLICA: Todos pueden ver el leaderboard
      allow read: if true;

      // CREAR: Solo usuarios autenticados no an√≥nimos
      allow create: if request.auth != null
                   && request.auth.token.firebase.sign_in_provider != 'anonymous'
                   && request.auth.uid == request.resource.data.userId
                   && request.resource.data.userId is string
                   && request.resource.data.nickname is string
                   && request.resource.data.score is number
                   && request.resource.data.score >= 0;

      // ACTUALIZAR: Solo el propietario puede actualizar su record si mejora
      allow update: if request.auth != null
                   && request.auth.token.firebase.sign_in_provider != 'anonymous'
                   && request.auth.uid == resource.data.userId
                   && request.auth.uid == request.resource.data.userId
                   && request.resource.data.score >= resource.data.score;

      // No permitir delete para mantener integridad
      allow delete: if false;
    }nced (ARQUITECTURA CORREGIDA)

## ÔøΩ CONFIGURACI√ìN CR√çTICA PARA RESOLVER ERRORES DE PERMISOS

**Problema detectado:** El c√≥digo usa las nuevas colecciones (`leaderboard_scores`, `user_game_history`, `user_stats`) pero las reglas de Firestore est√°n configuradas para colecciones antiguas.

## üìã REGLAS ACTUALIZADAS (COPIAR EXACTAMENTE)

Ve a [Firebase Console ‚Üí Firestore ‚Üí Rules](https://console.firebase.google.com/project/flappy-bird-enhanced/firestore/rules) y reemplaza completamente las reglas con esto:

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // üë§ USUARIOS: Gesti√≥n de perfiles y nicknames
    match /users/{userId} {
      // Lectura p√∫blica para verificar nicknames √∫nicos
      allow read: if true;

      // Escritura solo para el usuario propietario autenticado no an√≥nimo
      allow write: if request.auth != null
                  && request.auth.token.firebase.sign_in_provider != 'anonymous'
                  && request.auth.uid == userId;
    }

    // ÔøΩ LEADERBOARD GLOBAL: Nueva colecci√≥n principal
    match /leaderboard_scores/{scoreId} {
      // LECTURA P√öBLICA: Todos pueden ver el leaderboard
      allow read: if true;

      // ESCRITURA: Solo usuarios autenticados no an√≥nimos
      allow create: if request.auth != null
                   && request.auth.token.firebase.sign_in_provider != 'anonymous'
                   && request.auth.uid == request.resource.data.userId
                   && request.resource.data.userId is string
                   && request.resource.data.nickname is string
                   && request.resource.data.score is number
                   && request.resource.data.score >= 0;

      // No permitir updates - cada score es un registro √∫nico
      allow update, delete: if false;
    }

    // üìö HISTORIAL PERSONAL: Partidas por usuario
    match /user_game_history/{userId} {
      // Solo el usuario puede leer su propio historial
      allow read: if request.auth != null
                 && request.auth.uid == userId;

      // Solo el usuario puede escribir en su colecci√≥n
      allow write: if request.auth != null
                  && request.auth.token.firebase.sign_in_provider != 'anonymous'
                  && request.auth.uid == userId;

      // Subcolecci√≥n de partidas individuales
      match /games/{gameId} {
        // Solo el usuario puede acceder a sus partidas
        allow read, write: if request.auth != null
                          && request.auth.token.firebase.sign_in_provider != 'anonymous'
                          && request.auth.uid == userId;
      }
    }

    // üìä ESTAD√çSTICAS DE USUARIO: Datos agregados
    match /user_stats/{userId} {
      // LECTURA: Solo el usuario puede ver sus estad√≠sticas
      allow read: if request.auth != null
                 && request.auth.uid == userId;

      // ESCRITURA: Solo el usuario puede actualizar sus estad√≠sticas
      allow write: if request.auth != null
                  && request.auth.token.firebase.sign_in_provider != 'anonymous'
                  && request.auth.uid == userId;
    }

    // üóëÔ∏è COLECCIONES DEPRECATED (mantenidas para compatibilidad)
    match /game_sessions/{sessionId} {
      allow read: if false;
      allow write: if false;
    }

    match /leaderboard/{recordId} {
      allow read: if false;
      allow write: if false;
    }
  }
}
```

## ÔøΩ NUEVA ARQUITECTURA DE COLECCIONES

### 1. **`leaderboard_scores`** - Leaderboard Global

- **Prop√≥sito:** UN REGISTRO √öNICO por usuario con su MEJOR SCORE
- **Acceso:** Lectura p√∫blica, escritura/actualizaci√≥n solo del propietario
- **L√≥gica:** Crear en primera partida, actualizar solo si supera record anterior

### 2. **`user_game_history/{userId}/games/{gameId}`** - Historial Personal

- **Prop√≥sito:** Historial completo de partidas por usuario
- **Acceso:** Solo el usuario propietario
- **L√≥gica:** Subcolecci√≥n para organizar datos por usuario

### 3. **`user_stats/{userId}`** - Estad√≠sticas Agregadas

- **Prop√≥sito:** Estad√≠sticas calculadas por usuario (totalGames, bestScore, etc.)
- **Acceso:** Solo el usuario propietario
- **L√≥gica:** Un documento por usuario con datos agregados

## ‚úÖ VALIDACIONES INCLUIDAS

- ‚úÖ **Solo usuarios registrados** (no an√≥nimos) pueden guardar scores
- ‚úÖ **Validaci√≥n de ownership** - usuarios solo pueden modificar sus datos
- ‚úÖ **Validaci√≥n de datos** - score debe ser n√∫mero positivo
- ‚úÖ **Leaderboard p√∫blico** - cualquiera puede ver rankings
- ‚úÖ **Privacidad personal** - solo el usuario ve su historial y stats

## üöÄ PASOS PARA APLICAR (URGENTE)

1. **Copiar** las reglas de arriba EXACTAMENTE
2. **Ir** a [Firebase Console ‚Üí tu proyecto ‚Üí Firestore ‚Üí Rules](https://console.firebase.google.com/project/flappy-bird-enhanced/firestore/rules)
3. **Reemplazar completamente** las reglas existentes
4. **Publicar** cambios (bot√≥n "Publish" o "Publicar")
5. **Esperar 1-2 minutos** para propagaci√≥n

## üéÆ FLUJO PROFESIONAL DE LEADERBOARD

Tu propuesta es excelente y se implementar√° as√≠:

### **L√≥gica para Cada Usuario:**

1. **Primera partida** ‚Üí Crea entrada en `leaderboard_scores`
2. **Partidas siguientes** ‚Üí Siempre crean nueva entrada en `leaderboard_scores`
3. **Ranking din√°mico** ‚Üí Se calcula en tiempo real basado en todos los scores
4. **Mejor score personal** ‚Üí Se obtiene consultando el max score del usuario

### **Ventajas del Sistema:**

- ‚úÖ **Historial completo:** Todas las partidas se guardan
- ‚úÖ **Ranking justo:** Se basa en el mejor score real de cada usuario
- ‚úÖ **Performance:** Queries optimizadas con √≠ndices
- ‚úÖ **Escalabilidad:** Funciona con miles de usuarios

## üîß DESPU√âS DE APLICAR REGLAS

1. **Probar inmediatamente** el juego local
2. **Verificar** que se guardan scores sin errores
3. **Confirmar** que el leaderboard se muestra correctamente
4. **Continuar** con implementaci√≥n de UI del leaderboard

---

**‚ö†Ô∏è CR√çTICO:** Estas reglas deben aplicarse AHORA mismo para resolver los errores de permisos que viste en las pruebas.

      // Crear record inicial: usuarios autenticados no an√≥nimos
      allow create: if request.auth != null
                   && request.auth.token.firebase.sign_in_provider != 'anonymous'
                   && request.auth.uid == request.resource.data.userId
                   && request.resource.data.userId is string
                   && request.resource.data.nickname is string
                   && request.resource.data.score is number
                   && request.resource.data.score >= 0;

      // Actualizar record: solo el propietario puede actualizar su record
      allow update: if request.auth != null
                   && request.auth.uid == resource.data.userId
                   && request.auth.uid == request.resource.data.userId
                   && request.resource.data.score >= resource.data.score; // Solo si mejora

      // No permitir delete para mantener integridad del leaderboard
      allow delete: if false;
    }

    // üóëÔ∏è DEPRECATED: Mantenemos leaderboard_scores temporalmente para migraci√≥n
    match /leaderboard_scores/{scoreId} {
      // Solo lectura durante migraci√≥n
      allow read: if true;
      allow write: if false; // Ya no se usa para nuevos records
    }

}
}

```

## üéØ Explicaci√≥n de la Nueva Arquitectura:

### 1. **`/game_sessions/{sessionId}`**:

- **Prop√≥sito**: Historial completo de todas las partidas jugadas
- **Privacidad**: Solo el usuario puede ver sus propias sesiones
- **Integridad**: No se permite modificar o borrar sesiones una vez creadas

### 2. **`/leaderboard/{recordId}`**:

- **Prop√≥sito**: Solo los mejores records √∫nicos por usuario
- **Visibilidad**: P√∫blico para mostrar ranking global
- **L√≥gica**: Los users solo pueden actualizar si mejoran su score
- **Unicidad**: Un solo documento por usuario

### 3. **`/leaderboard_scores/{scoreId}` [DEPRECATED]**:

- **Lectura p√∫blica**: Todos pueden ver el leaderboard
- **Escritura controlada**: Solo usuarios registrados pueden crear scores
- **Validaci√≥n de datos**: Asegura que el score tenga los campos correctos
- **Inmutabilidad**: Una vez creado, no se puede modificar (integridad del leaderboard)

## Validaciones incluidas:

- ‚úÖ Solo usuarios autenticados no an√≥nimos pueden guardar scores
- ‚úÖ El usuario solo puede guardar scores con su propio UID
- ‚úÖ Los datos deben tener nickname y score v√°lidos
- ‚úÖ El score debe ser un n√∫mero positivo
- ‚úÖ Una vez guardado, el score no se puede modificar

## Pasos para configurar:

1. Ve a Firebase Console ‚Üí tu proyecto ‚Üí Firestore Database
   - **Estado**: Colecci√≥n antigua que causaba duplicados
   - **Acceso**: Solo lectura durante migraci√≥n
   - **Migraci√≥n**: Se eliminar√° una vez migrados los datos

## üîß Pasos para Aplicar las Reglas:

1. **Copiar** las reglas de arriba
2. **Ir** a [Firebase Console ‚Üí Firestore ‚Üí Rules](https://console.firebase.google.com/project/flappy-bird-enhanced/firestore/rules)
3. **Pegar** las nuevas reglas
4. **Publicar** los cambios

## ‚ö†Ô∏è Importante:

- Las nuevas reglas **no afectan** los datos existentes
- Los datos en `leaderboard_scores` siguen siendo accesibles para migraci√≥n
- La nueva l√≥gica de `FirebaseManager.js` maneja autom√°ticamente ambas colecciones

## üéØ Beneficios de la Nueva Arquitectura:

‚úÖ **Eliminaci√≥n de duplicados**: Un solo record por usuario en leaderboard
‚úÖ **Historial completo**: Todas las partidas se guardan en game_sessions
‚úÖ **Performance mejorado**: Consultas m√°s eficientes en leaderboard
‚úÖ **Integridad de datos**: Reglas estrictas para prevenir corrupci√≥n

---

**¬°LISTO!** Con estas nuevas reglas y la l√≥gica actualizada en `FirebaseManager.js`, el sistema de leaderboard ya no crear√° duplicados por usuario.
```
